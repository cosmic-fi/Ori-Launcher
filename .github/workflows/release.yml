name: Create Public Release
on:
  workflow_run:
    workflows: ["Build Application"]  # Must match the private repo workflow name exactly
    types:
      - completed
    branches: [main]  # Optional: only trigger from main branch

jobs:
  release:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    
    steps:
    - name: Checkout public repo
      uses: actions/checkout@v4
    
    - name: Download artifacts from private repo
      uses: actions/download-artifact@v4
      with:
        github-token: ${{ secrets.PRIVATE_REPO_PAT }}
        run-id: ${{ github.event.workflow_run.id }}
        repository: cosmic-fi/Ori-Launcher-Prologue  # Your private repo
        path: downloaded-artifacts/
    
    - name: Get tag name from private workflow
      run: |
        # Extract the tag from the workflow run name or use a fallback
        echo "TAG_NAME=${{ github.event.workflow_run.head_branch || github.event.workflow_run.display_title }}" >> $GITHUB_ENV
    
    - name: Organize artifacts
      run: |
        mkdir -p release-assets
        find downloaded-artifacts/ -type f \( -name "*.exe" -o -name "*.dmg" -o -name "*.AppImage" -o -name "*.zip" -o -name "*.blockmap" \) -exec cp {} release-assets/ \;
        echo "Artifacts found:"
        ls -la release-assets/
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.TAG_NAME }}
        name: Release ${{ env.TAG_NAME }}
        body: |
          Automated release built from private repository.
          
          **Build Details:**
          - Source: Private repository (cosmic-fi/Ori-Launcher-Prologue)
          - Workflow Run: ${{ github.event.workflow_run.html_url }}
          - Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        files: release-assets/*
        draft: false
        prerelease: ${{ contains(env.TAG_NAME, 'alpha') || contains(env.TAG_NAME, 'beta') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
